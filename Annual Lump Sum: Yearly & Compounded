//@version=5
indicator("Annual Lump Sum: Yearly & Compounded", overlay=true)

// --- Inputs ---
invest_amount = input.float(10000.0, "Annual Investment Amount ($)", minval=1.0)
table_size    = input.string("Small", "Table Size", options=["Tiny", "Small", "Normal", "Large"])
max_rows      = input.int(20, "Max Years to Display", minval=5, maxval=100, tooltip="Limits the table length to fit on screen.")

// --- Arrays to store history ---
var int[]   history_years       = array.new_int(0)
var float[] history_buy_price   = array.new_float(0)
var float[] history_end_price   = array.new_float(0)
var float[] history_yield       = array.new_float(0)

// --- Logic ---
is_new_year = year(time) != year(time[1])

// Global Strategy Variables
var float total_invested = 0.0
var float total_shares_owned = 0.0

if is_new_year
    // 1. Logic for the PREVIOUS year (The one that just finished)
    if array.size(history_years) > 0
        // The bar before this new year started was the last trading day of the prev year
        last_year_close = close[1]
        
        // Update the last entry in our arrays with the final closing price
        last_idx = array.size(history_years) - 1
        buy_price_prev = array.get(history_buy_price, last_idx)
        
        // Calculate final discrete yield for that specific year (Jan 1 to Dec 31)
        yield_prev = ((last_year_close - buy_price_prev) / buy_price_prev) * 100
        
        // Save to arrays
        array.set(history_end_price, last_idx, last_year_close)
        array.set(history_yield, last_idx, yield_prev)

    // 2. Logic for the NEW (Current) year
    shares_bought = invest_amount / close
    total_shares_owned += shares_bought
    total_invested += invest_amount
    
    // Add new entry for this new year
    array.push(history_years, year(time))
    array.push(history_buy_price, close)
    array.push(history_end_price, close) // Temporary, will update live
    array.push(history_yield, 0.0)        // Temporary, will update live

// --- Live Updates for the Current Year ---
if array.size(history_years) > 0
    last_idx = array.size(history_years) - 1
    current_buy_price = array.get(history_buy_price, last_idx)
    current_yield = ((close - current_buy_price) / current_buy_price) * 100
    
    array.set(history_end_price, last_idx, close)
    array.set(history_yield, last_idx, current_yield)

// --- Visuals ---
plotshape(is_new_year, style=shape.labelup, location=location.belowbar, color=color.green, size=size.small, title="Annual Buy", text="BUY")

// --- Table Generation ---
// We now have 5 Columns
var table results_table = table.new(position.bottom_right, 5, 3 + max_rows, border_width=1, border_color=color.gray)

if barstate.islast
    t_size = switch table_size
        "Tiny" => size.tiny
        "Small" => size.small
        "Normal" => size.normal
        "Large" => size.large

    // --- SECTION 1: OVERALL SUMMARY ---
    current_val = total_shares_owned * close
    
    // Header (Merged across 5 columns)
    table.cell(results_table, 0, 0, "Strategy Overview", bgcolor=color.new(color.blue, 30), text_color=color.white, text_size=t_size)
    table.merge_cells(results_table, 0, 0, 4, 0)
    
    // Summary Data
    table.cell(results_table, 0, 1, "Invested: $" + str.tostring(total_invested, format.mintick), bgcolor=color.new(color.gray, 90), text_size=t_size, text_halign=text.align_left)
    table.merge_cells(results_table, 0, 1, 1, 1) // Merge cols 0-1
    
    table.cell(results_table, 2, 1, "Value: $" + str.tostring(current_val, format.mintick), bgcolor=color.new(color.gray, 90), text_size=t_size, text_halign=text.align_right)
    table.merge_cells(results_table, 2, 1, 4, 1) // Merge cols 2-4

    // --- SECTION 2: YEARLY BREAKDOWN ---
    // Headers
    header_bg = color.new(color.gray, 80)
    table.cell(results_table, 0, 2, "Year", bgcolor=header_bg, text_size=t_size)
    table.cell(results_table, 1, 2, "Buy Price", bgcolor=header_bg, text_size=t_size)
    table.cell(results_table, 2, 2, "End Price", bgcolor=header_bg, text_size=t_size)
    table.cell(results_table, 3, 2, "Yearly %", bgcolor=header_bg, text_size=t_size)
    table.cell(results_table, 4, 2, "Compounded %", bgcolor=color.new(color.blue, 60), text_color=color.white, text_size=t_size)

    // Data Loop
    count = array.size(history_years)
    print_rows = math.min(count, max_rows)
    
    if count > 0
        for i = 0 to print_rows - 1
            idx = count - 1 - i 
            
            y_year = array.get(history_years, idx)
            y_buy  = array.get(history_buy_price, idx)
            y_end  = array.get(history_end_price, idx)
            y_yld  = array.get(history_yield, idx)
            
            // Calculate Compounded Yield (Return since buy date until NOW)
            // ((Current Price - Original Buy Price) / Original Buy Price) * 100
            comp_yld = ((close - y_buy) / y_buy) * 100
            
            // Color Logic (Based on the Yearly Yield)
            row_color = y_yld >= 0 ? color.new(color.green, 60) : color.new(color.red, 60)
            comp_color = comp_yld >= 0 ? color.new(color.green, 40) : color.new(color.red, 40)
            text_col  = color.white
            
            r = 3 + i
            
            table.cell(results_table, 0, r, str.tostring(y_year), bgcolor=row_color, text_color=text_col, text_size=t_size)
            table.cell(results_table, 1, r, str.tostring(y_buy, format.mintick), bgcolor=row_color, text_color=text_col, text_size=t_size)
            table.cell(results_table, 2, r, str.tostring(y_end, format.mintick), bgcolor=row_color, text_color=text_col, text_size=t_size)
            table.cell(results_table, 3, r, str.tostring(y_yld, "#.##") + "%", bgcolor=row_color, text_color=text_col, text_size=t_size)
            table.cell(results_table, 4, r, str.tostring(comp_yld, "#.##") + "%", bgcolor=comp_color, text_color=text_col, text_size=t_size)
