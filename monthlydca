/*
This Pine Script indicator simulates a Monthly Dollar Cost Averaging (DCA) strategy directly on your TradingView chart. 
It automatically calculates a hypothetical portfolio where a fixed dollar amount (default $100) is invested on the first trading day of every month.
*/

//@version=5
indicator("Monthly DCA & Yearly Table", overlay=true, max_lines_count=500, max_labels_count=500)

// --- Inputs ---
i_investAmount = input.float(100.0, "Monthly Investment ($)", minval=1.0)
i_startYear    = input.int(2015, "Start Year", minval=1900)
i_tablePos     = input.string(position.bottom_right, "Table Position", options=[position.top_right, position.bottom_right, position.top_left, position.bottom_left])

// --- Variables to track Global Portfolio ---
var float total_invested = 0.0
var float total_coins    = 0.0
var float avg_price      = 0.0

// --- Variables to track Yearly Data (using Arrays) ---
var int[]   year_list       = array.new_int(0)
var float[] year_invested   = array.new_float(0)
var float[] year_coins      = array.new_float(0)

// --- Logic to Determine Buy Timing (MONTHLY) ---
// 1. Detect if we are on a Monthly timeframe chart (where every bar is a month)
is_monthly_chart = timeframe.ismonthly

// 2. Detect the start of a new month (for Daily or Weekly charts)
// ta.change(time("M")) returns a value when the month changes compared to the previous bar
is_new_month = ta.change(time("M"))

// Combined Logic:
// If chart is Monthly, buy every bar. If chart is Daily/Weekly, buy when the month changes.
is_buy_day = is_monthly_chart ? true : is_new_month

// Only process if within the date range
bool date_allowed = year >= i_startYear

// --- Main Execution Loop ---
if is_buy_day and date_allowed and barstate.isconfirmed
    // 1. Update Global Stats
    float coins_bought = i_investAmount / close
    total_invested    := total_invested + i_investAmount
    total_coins       := total_coins + coins_bought
    avg_price         := total_invested / total_coins
    
    // 2. Update Yearly Stats
    int current_year = year(time)
    
    // Check if this year exists in our array yet
    int y_index = -1
    if array.size(year_list) > 0
        // Look for the year
        for i = 0 to array.size(year_list) - 1
            if array.get(year_list, i) == current_year
                y_index := i
                break
    
    // If year not found, add new entry
    if y_index == -1
        array.push(year_list, current_year)
        array.push(year_invested, 0.0)
        array.push(year_coins, 0.0)
        y_index := array.size(year_list) - 1
    
    // Add data to the specific year index
    float current_y_inv   = array.get(year_invested, y_index)
    float current_y_coins = array.get(year_coins, y_index)
    
    array.set(year_invested, y_index, current_y_inv + i_investAmount)
    array.set(year_coins, y_index, current_y_coins + coins_bought)

    // 3. Visuals on Chart
    // Plot a small "B" label for Buy
    label.new(bar_index, low, "B", color=color.green, style=label.style_label_up, size=size.tiny, textcolor=color.white)

// --- Plotting Global Average Price ---
plot(total_invested > 0 ? avg_price : na, "Global Breakeven Price", color=color.yellow, linewidth=2)

// --- Table Generation (Render only on last bar) ---
var table dcaTable = table.new(i_tablePos, 6, 20, border_width=1)

if barstate.islast
    // Header Row
    table.cell(dcaTable, 0, 0, "Year", bgcolor=color.gray, text_color=color.white)
    table.cell(dcaTable, 1, 0, "Invested", bgcolor=color.gray, text_color=color.white)
    table.cell(dcaTable, 2, 0, "Avg Price", bgcolor=color.gray, text_color=color.white)
    table.cell(dcaTable, 3, 0, "Coins", bgcolor=color.gray, text_color=color.white)
    table.cell(dcaTable, 4, 0, "Cur Value", bgcolor=color.gray, text_color=color.white)
    table.cell(dcaTable, 5, 0, "PnL %", bgcolor=color.gray, text_color=color.white)
    
    float grand_total_val = 0.0
    
    // Loop through years and fill rows
    if array.size(year_list) > 0
        for i = 0 to array.size(year_list) - 1
            int   y_val      = array.get(year_list, i)
            float y_inv      = array.get(year_invested, i)
            float y_amt      = array.get(year_coins, i)
            float y_avg      = y_inv / y_amt
            float y_cur_val  = y_amt * close
            float y_pnl      = ((y_cur_val - y_inv) / y_inv) * 100
            
            grand_total_val := grand_total_val + y_cur_val
            
            // Color logic for PnL
            color pnl_color = y_pnl >= 0 ? color.new(color.green, 60) : color.new(color.red, 60)
            
            table.cell(dcaTable, 0, i + 1, str.tostring(y_val), text_color=color.white, bgcolor=color.new(color.gray, 80))
            table.cell(dcaTable, 1, i + 1, "$" + str.tostring(y_inv, "#.##"), text_color=color.white, bgcolor=color.new(color.gray, 90))
            table.cell(dcaTable, 2, i + 1, str.tostring(y_avg, "#.##"), text_color=color.white, bgcolor=color.new(color.gray, 90))
            table.cell(dcaTable, 3, i + 1, str.tostring(y_amt, "#.###"), text_color=color.white, bgcolor=color.new(color.gray, 90))
            table.cell(dcaTable, 4, i + 1, "$" + str.tostring(y_cur_val, "#.##"), text_color=color.white, bgcolor=pnl_color)
            table.cell(dcaTable, 5, i + 1, str.tostring(y_pnl, "#.##") + "%", text_color=color.white, bgcolor=pnl_color)

    // Total Summary Row
    int last_row = array.size(year_list) + 1
    float total_pnl_pct = total_invested > 0 ? ((grand_total_val - total_invested) / total_invested) * 100 : 0.0
    color total_color = total_pnl_pct >= 0 ? color.green : color.red
    
    table.cell(dcaTable, 0, last_row, "TOTAL", bgcolor=total_color, text_color=color.white)
    table.cell(dcaTable, 1, last_row, "$" + str.tostring(total_invested, "#.##"), bgcolor=total_color, text_color=color.white)
    table.cell(dcaTable, 2, last_row, str.tostring(avg_price, "#.##"), bgcolor=total_color, text_color=color.white)
    table.cell(dcaTable, 3, last_row, str.tostring(total_coins, "#.###"), bgcolor=total_color, text_color=color.white)
    table.cell(dcaTable, 4, last_row, "$" + str.tostring(grand_total_val, "#.##"), bgcolor=total_color, text_color=color.white)
    table.cell(dcaTable, 5, last_row, str.tostring(total_pnl_pct, "#.##") + "%", bgcolor=total_color, text_color=color.white)
